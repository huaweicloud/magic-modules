#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2018 Huawei
# GNU General Public License v3.0+ (see COPYING or
# https://www.gnu.org/licenses/gpl-3.0.txt)
<%= lines(autogen_notice :python) -%>

from __future__ import absolute_import, division, print_function
__metaclass__ = type

###############################################################################
# Documentation
###############################################################################

<%
  metadata_version = quote_string(@config.manifest.get('metadata_version',
                                                       config))
  supported_by = quote_string(@config.manifest.get('supported_by', config))
-%>
ANSIBLE_METADATA = {'metadata_version': <%= metadata_version -%>,
                    'status': <%= @config.manifest.get('status', config) -%>,
                    'supported_by': <%= supported_by -%>}

DOCUMENTATION = '''
---
module: <%= module_name(object) %>
description:
<%= lines(indent(bullet_lines(object.description, 4), 4)) -%>
short_description: Creates a Huawei Cloud <%= object.name %>
version_added: <%= lines(@config.manifest.get('version_added', config)) -%>
author: <%= lines(@config.manifest.get('author', config)) -%>
requirements:
<% @config.manifest.get('requirements', config).each do |line| -%>
<%= lines(indent(bullet_line(line, 4, false, false), 4)) -%>
<% end -%>
options:
    state:
        description:
            - Whether the given object should exist in GCP
        choices: ['present', 'absent']
        default: 'present'
<% object.all_user_properties.reject(&:output).each do |prop| -%>
<%= lines(indent(doc_property_yaml(prop, object, 4), 4)) -%>
<% end -%>
extends_documentation_fragment: hwc
'''

<%if example -%>
EXAMPLES = '''
<%#<% res_readable_name = Google::StringUtils.uncombine(object.name) -%>
<% if example.dependencies -%>
<%   example.dependencies.each do |depend| -%>
<%= lines(depend.build_test('present', object, false)) -%>
<%   end # example.dependencies.each -%>
<% end # if example.dependencies -%>
<%= lines(example.task.build_example('present', object)) -%>
'''
<% end -%>

RETURN = '''
<% object.all_user_properties.each do |prop| -%>
<%= lines(indent(return_property_yaml(prop, 4), 4)) -%>
<% end -%>
'''

###############################################################################
# Imports
###############################################################################

from ansible.module_utils.hwc_utils import (HwcSession, HwcModule,
                                            DictComparison, navigate_hash,
                                            remove_nones_from_dict,
                                            remove_empty_from_dict)
<%
  imports = ['json']
  imports << 'time' if object.async
  imports << 're'
-%>
<%= lines(imports.sort.uniq.map { |i| "import #{i}" }) -%>

###############################################################################
# Main
###############################################################################


<%
  prod_name = object.__product.prefix[1..-1]
  no_ex_properties = object.ex_properties.empty?
-%>
def main():
    """Main function"""

<%
  mod_props = object.all_user_properties.reject(&:output).map do |prop|
    python_dict_for_property(prop, object)
  end
  obj_update_url = 'self_link(session)'
  obj_delete_url = 'self_link(session)'
  if object.update_url && object.delete_url && object.update_url == object.delete_url
    obj_update_url = 'update_delete_url(session)'
    obj_delete_url = 'update_delete_url(session)'
  else
    if object.update_url
      obj_update_url = 'update_url(session)'
    end
    if object.delete_url
      obj_delete_url = 'delete_url(session)'
    end
  end
-%>
    module = HwcModule(
        argument_spec=dict(
            state=dict(default='present', choices=['present', 'absent'], type='str'),
<%= lines(indent_list(mod_props, 12)) -%>
        )
    )
    session = HwcSession(module, <%= quote_string(prod_name) -%>)

    state = module.params['state']
<% if object.kind? -%>
    kind = <%= lines(quote_string(object.kind)) -%>
<% end -%>

<% if object.self_link_query.nil? -%>
<%
  method_fetch = method_call('fetch_resource', ['session', 'link',
                                                ('kind' if object.kind?),
                                                ('[' + object.get_codes.join(', ') + ']' if object.get_codes)
                                               ])
-%>
<%   if self_link_url(object).match('/{id}') -%>
    if (not module.params.get("id")) and module.params.get("name"):
        module.params['id'] = get_id_by_name(session)

<%   end -%>
<%   if no_ex_properties -%>
    fetch = None
    link = self_link(session)
    # the link will include Nones if required format parameters are missed
    if not re.search('/None/|/None$', link):
        fetch = <%= method_fetch %>
<%     if object.msg_prefix -%>
        if fetch:
            fetch = fetch.get(<%= quote_string(object.msg_prefix) %>)
<%     end  # object.msg_prefix -%>
<%   else -%>
    fetch = get_resource(session)
<%   end # no_ex_properties -%>
<% else # object.self_link_query.nil? -%>
    fetch = fetch_wrapped_resource(module, '<%= object.kind -%>',
                                   '<%= object.self_link_query.kind -%>',
                                   '<%= object.self_link_query.items -%>')
<% end # object.self_link_query.nil? -%>
    changed = False
<% if object.virtual -%>
    if not fetch:
        module.fail_json(msg="<%= object.name -%> is not valid")
<% else # object.virtual -%>

    if fetch:
        if state == 'present':
            expect = _get_editable_properties(module)
            current_state = response_to_hash(module, fetch)
            if is_different(expect, current_state):
<%
  method_update = method_call('update', ['session', obj_update_url,
                                         ('kind' if object.kind?),
                                         ('fetch' if object.save_api_results?),
                                         ('[' + object.update_codes.join(', ') + ']' if object.update_codes)
                                        ])
-%>
<%   if no_ex_properties -%>
<%= lines(indent("fetch = #{method_update}", 16)) -%>
                fetch = response_to_hash(module, <%= object.msg_prefix ? "fetch.get(\'#{object.msg_prefix}\')" : 'fetch'%>)
<%   else -%>
                fetch = update_resource(session, current_state, fetch)
                fetch = response_to_hash(module, fetch)
<%   end  # no_ex_properties -%>
                changed = True
            else:
                fetch = current_state
        else:
<%
  method = method_call('delete', [
                                   'session', obj_delete_url,
                                   ('kind' if object.kind?),
                                   ('fetch' if object.save_api_results?),
                                   ('[' + object.delete_codes.join(', ') + ']' if object.delete_codes)
                                 ])
-%>
<%= lines(indent(method, 12)) -%>
            fetch = {}
            changed = True
    else:
        if state == 'present':
<%
  if object.create_verb.nil? || object.create_verb == :POST
    create_link = 'collection(session)'
  elsif object.create_verb == :PUT
    create_link = 'self_link(session)'
  else
    raise "Ansible does not support create_verb #{object.create_verb}"
  end
  method_create = method_call('create', ['session', create_link,
                                         ('kind' if object.kind?),
                                         ('[' + object.create_codes.join(', ') + ']' if object.create_codes)])
-%>
<% if no_ex_properties -%>
            fetch = <%= method_create %>
            fetch = response_to_hash(module, <%= object.msg_prefix ? "fetch.get(\'#{object.msg_prefix}\')" : 'fetch'%>)
<% else -%>
            fetch = create_resource(session)
            fetch = response_to_hash(module, fetch)
<% end -%>
            changed = True
        else:
            fetch = {}

    fetch.update({'changed': changed})
<% end # object.virtual -%>

    module.exit_json(**fetch)


<% unless object.virtual -%>
<%# TODO: kind param not always needed.
  # https://github.com/GoogleCloudPlatform/magic-modules/issues/45
-%>
<%= method_decl('create', ['session', 'link', ('kind' if object.kind?), 'success_codes=None']) %>
<% if object.create.nil? -%>
    if not success_codes:
        success_codes = [201, 202]
<%
  if object.create_verb.nil? || object.create_verb == :POST
    create_verb = '.post'
  elsif object.create_verb == :PUT
    create_verb = '.put'
  else
    raise "Ansible does not support create_verb #{object.create_verb}"
  end
-%>
    module = session.module
<%
  method = method_call(
    'return_if_object',
    ['module',
     method_call("session#{create_verb}",
                 ['link', 'resource_to_create(module)']),
     ('kind' if !object.async && object.kind?),
     'success_codes'
   ]
  )
-%>
<%   if not object.async -%>
    return <%= method %>
<%   else -%>
    r = <%= method %>

    wait_done = wait_for_operation(session, 'create', r)

    url = resource_get_url(session, wait_done)
<%
  method = method_call('fetch_resource', ['session', 'url',
                                          ('kind' if object.kind?),
                                          ('[' + object.get_codes.join(', ') + ']' if object.get_codes)
                                         ])
-%>
    return <%= method %>
<%   end -%>
<% else -%>
<%= lines(indent(object.create, 4)) -%>
<% end -%>


<%=
  lines(method_decl('update', ['session', 'link', ('kind' if object.kind?),
                               ('fetch' if object.save_api_results?),
                               'success_codes=None']))
-%>
<% if object.update.nil? -%>
<%   if !false?(object.editable) -%>
    if not success_codes:
        success_codes = [201, 202]
    module = session.module
<%
  method = method_call(
    'return_if_object',
    [
     'module',
     method_call("session.put", ['link', 'resource_to_update(module)']),
     ('kind' if !object.async && object.kind?),
     'success_codes'
   ]
  )
-%>
<%   if not object.async -%>
    return <%= method %>
<%   else -%>
    r = <%= method %>

    wait_done = wait_for_operation(session, 'update', r)

    url = resource_get_url(session, wait_done)
<%
  method = method_call('fetch_resource', ['session', 'url',
                                          ('kind' if object.kind?),
                                          ('[' + object.get_codes.join(', ') + ']' if object.get_codes)
                                         ])
-%>
    return <%= method %>
<%     end -%>
<%   else # !false?(object.editable) -%>
    module.fail_json(msg="<%= object.name -%> cannot be edited")
<%   end # !false?(object.editable) -%>
<% else # object.update.nil? -%>
<%= lines(indent(object.update, 4)) -%>
<% end # object.update.nil? -%>


<%=
  lines(method_decl('delete', ['session', 'link', ('kind' if object.kind?),
                               ('fetch' if object.save_api_results?),
                               'success_codes=None']))
-%>
<% if object.delete.nil? -%>
    if not success_codes:
        success_codes = [202, 204]
<%
  method = method_call(
    'return_if_object',
    ['session.module',
     method_call("session.delete", ['link']),
     ('kind' if !object.async && object.kind?),
     'success_codes',
     'False'
   ]
  )

  method1 = method_call(
    'return_if_object',
    ['session.module',
     method_call("session.delete", ['link']),
     ('kind' if !object.async && object.kind?),
     'success_codes'
   ]
  )
-%>
<%   if not object.async -%>
    <%= method %>
<%   else -%>
<%
  async_op_st = object.async.operation.service_type
  async_op_url = object.async.operation.base_url.gsub(/{.*}/, ' ')
  object_self_link = self_link_url(object).gsub(/{.*}/, ' ')
-%>
<%     if (not async_op_st || async_op_st == object.service_type) && async_op_url == object_self_link -%>
    <%= method %>

    wait_for_delete(session, link)
<%     else -%>
    r = <%= method1 %>

    wait_for_operation(session, 'delete', r)
<%     end -%>
<%   end -%>
<% else # if object.delete.nil? -%>
<%= lines(indent(object.delete, 4)) -%>
<% end # if object.delete.nil? -%>


<% end # unless object.virtual -%>
<%= lines(compile('templates/ansible/transport.erb'), 2) -%>
<% unless no_ex_properties -%>
<%
   resource_editable_ps = object.properties.reject(&:output).reject(&:update_url).select { |p| p.create_update == 'u' || p.create_update == 'cu' }
   internals = object.ex_properties.reject{|p1| p1.ex_property_opts&.get_url}
   internals_create = object.ex_properties.reject{|p1| p1.ex_property_opts&.get_url}.select{|p1| p1.create_update == 'u'}
   externals = object.ex_properties.select{|p1| p1.ex_property_opts&.get_url}
-%>
def get_resource(session):
    link = self_link(session)
    # the link will include Nones if required format parameters are missed
    if re.search('/None/|/None$', link):
        return None

    fetch = <%= method_fetch %>
    if not fetch:
        return fetch
<%   if object.msg_prefix -%>
    fetch = fetch.get(<%= quote_string(object.msg_prefix) %>)
<%   end  # object.msg_prefix -%>

<%   externals.each do |p| -%>
    r = <%= p.property_class[-1] -%>ExProperty(session).fetch()
    if isinstance(r, dict):
        fetch.update(r)

<%   end -%>
    return fetch


def update_resource(session, current_state, resource):
<% unless internals.empty? && externals.empty? -%>
    params = session.module.params
<% end -%>
<% unless internals.empty? -%>
    need_read = False

<%   internals.each do |p| -%>
    expect = <%= "{\"#{p.out_name}\": params.get(\"#{p.out_name}\"),}" %>
    actual = <%= "{\"#{p.out_name}\": current_state.get(\"#{p.out_name}\"),}" %>
    if DictComparison(expect) != DictComparison(actual):
        <%= p.property_class[-1] -%>ExProperty(session).update()
        need_read = True

<%   end -%>
<% end -%>
    obj = resource
<% unless resource_editable_ps.empty? -%>
    expect = _get_resource_editable_properties(session.module)
    if is_different(expect, current_state):
        obj = <%= method_update %>
<%   if object.msg_prefix -%>
        obj = obj.get(<%= quote_string(object.msg_prefix) %>)
<%   end  # object.msg_prefix -%>
<% end -%>
<% unless internals.empty? -%>
<%   if resource_editable_ps.empty? -%>
    if need_read:
<%   else -%>
    elif need_read:
<%   end -%>
        obj = <%= method_fetch %>
<%   if object.msg_prefix -%>
        obj = obj.get(<%= quote_string(object.msg_prefix) %>)
<%   end  # object.msg_prefix -%>
<% end -%>

<% unless externals.empty? -%>
    result = {}
<%   externals.each do |p| -%>
    expect = <%= "{\"#{p.out_name}\": params.get(\"#{p.out_name}\"),}" %>
    actual = <%= "{\"#{p.out_name}\": current_state.get(\"#{p.out_name}\"),}" %>
    if DictComparison(expect) != DictComparison(actual):
        r = <%= p.property_class[-1] -%>ExProperty(session).update()
        if r:
            result.update(r)

<%   end -%>
    if result:
        obj.update(result)
<% end -%>
    return obj


def create_resource(session):
    obj = <%= method_create %>
<% if object.msg_prefix -%>
    obj = obj.get(<%= quote_string(object.msg_prefix) -%>)
<% end  # object.msg_prefix -%>
    session.module.params['id'] = obj.get('id', None)

<% unless internals_create.empty? && externals.empty? -%>
    params = session.module.params
<% end -%>
<% unless internals_create.empty? -%>
    need_read = False

<%   internals_create.each do |p| -%>
    if params.get(<%= quote_string(p.out_name) -%>) is not None:
        <%= p.property_class[-1] -%>ExProperty(session).update()
        need_read = True

<%   end -%>
    if need_read:
        obj = <%= method_fetch %>
<%   if object.msg_prefix -%>
        obj = obj.get(<%= quote_string(object.msg_prefix) -%>)
<%   end  # object.msg_prefix -%>

<% end -%>
<% unless externals.empty? -%>
    result = {}
<%   externals.each do |p| -%>
    if params.get(<%= quote_string(p.out_name) -%>) is not None:
        r = <%= p.property_class[-1] -%>ExProperty(session).update()
        if r:
            result.update(r)

<%   end -%>
    if result:
        obj.update(result)
<% end -%>
    return obj


<% end -%>
def link_wrapper(f):
    def _wrapper(module, *args, **kwargs):
        try:
            return f(module, *args, **kwargs)
        except KeyError as ex:
            module.fail_json(
                msg="Mapping keys(%s) are not found in generating link" % ex)

    return _wrapper


<% unless object.virtual || self_link_url(object).match('/{id}').nil? -%>
def get_id_by_name(session):
    module = session.module
    name = module.params.get("name")
    link = list_link(session, {'limit': 10, 'marker': '{marker}'})
    not_format_keys = re.findall("={marker}", link)
    none_values = re.findall("=None", link)

    if not (not_format_keys or none_values):
        r = fetch_resource(session, link)
        if r is None:
            return ""
<%   if object.list_msg_prefix -%>
        r = r.get(<%= quote_string(object.list_msg_prefix) %>, [])
<%   end  # object.msg_prefix -%>
        ids = [
            i.get('id') for i in r if i.get('name', '') == name
        ]
        if not ids:
            return ""
        elif len(ids) == 1:
            return ids[0]
        else:
            module.fail_json(msg="Multiple resources with same name are found")
    elif none_values:
        module.fail_json(
            msg="Can not find id by name because url includes None")
    else:
        p = {'marker': ''}
        ids = set()
        while True:
            r = fetch_resource(session, link.format(**p))
            if r is None:
                break
<%   if object.list_msg_prefix -%>
            r = r.get(<%= quote_string(object.list_msg_prefix) %>, [])
<%   end  # object.msg_prefix -%>
            if r == []:
                break
            for i in r:
                if i.get('name') == name:
                    ids.add(i.get('id'))
            if len(ids) >= 2:
                module.fail_json(
                    msg="Multiple resources with same name are found")

            p['marker'] = r[-1].get('id')

        return ids.pop() if ids else ""


<%= lines(emit_link('list_link', list_url(object), object, true, object.service_type)) -%>


<% end -%>
<%= lines(emit_link('self_link', self_link_url(object), object, false, object.service_type)) -%>


<%= lines(emit_link('collection', collection_url(object), object, false, object.service_type)) -%>


<%
  if object.update_url && object.delete_url && object.update_url == object.delete_url
    tmp_url = object.update_url.gsub('{{', '{').gsub('}}', '}')
-%>
<%=
    lines(emit_link('update_delete_url', tmp_url, object, false, object.service_type))
-%>


<%
  else
    if object.update_url
      tmp_url = object.update_url.gsub('{{', '{').gsub('}}', '}')
-%>
<%=
      lines(emit_link('update_url', tmp_url, object, false, object.service_type))
-%>


<%
    end
    if object.delete_url
      tmp_url = object.delete_url.gsub('{{', '{').gsub('}}', '}')
-%>
<%=
      lines(emit_link('delete_url', tmp_url, object, false, object.service_type))
-%>


<%
    end
  end
-%>
<%=
  lines(method_decl('return_if_object', ['module', 'response',
                                         ('kind' if object.kind?),
                                         'success_codes', 'has_content=True']))
-%>
    code = response.status_code

    # If not found, return nothing.
    if code == 404:
        return None

    success_codes = [200, 201, 202, 203, 204, 205, 206, 207, 208, 226]
    # If no content, return nothing.
    if code in success_codes and not has_content:
        return None

    result = None
    try:
        result = response.json()
    except getattr(json.decoder, 'JSONDecodeError', ValueError) as inst:
        module.fail_json(msg="Invalid JSON response with error: %s" % inst)

<% if object.decoder? -%>
    result = <%= object.transport.decoder -%>(result, module)

<% end -%>
    if code not in success_codes:
        msg = navigate_hash(result, ['message'])
        if msg:
            module.fail_json(msg=msg)
        else:
            module.fail_json(msg="operation failed, return code=%d" % code)
<% if object.kind? -%>
    if result['kind'] != kind:
        module.fail_json(msg="Incorrect result: {kind}".format(**result))
<% end # object.kind? -%>

    return result


def is_different(expect, actual):
    # Remove all output-only from actual.
    actual_vals = {}
    for k, v in actual.items():
        if k in expect:
            actual_vals[k] = v

    expect_vals = {}
    for k, v in expect.items():
        if k in actual:
            expect_vals[k] = v

    return DictComparison(expect_vals) != DictComparison(actual_vals)


def resource_to_create(module):
<%
  properties_in_request = [
    object&.parameters&.reject(&:alone_parameter)&.select { |p| p.input || p.create_update == 'c' || p.create_update == 'cu' },
    object.properties.reject(&:output).reject(&:update_url).select { |p| p.create_update == 'c' || p.create_update == 'cu' },
  ].flatten.compact
-%>
    request = remove_empty_from_dict({
<% if object.kind? -%>
        u'kind': <%= quote_string(object.kind) -%>,
<% end # if object.kind? -%>
<%= lines(indent(request_properties(properties_in_request), 4)) -%>
    })
<%
  alone = object.alone_parameters.select { |p| p.input || p.create_update == 'c' || p.create_update == 'cu' }
-%>
<% if not alone.empty? -%>
    alone_param = remove_empty_from_dict({
 <%= lines(indent(request_properties(alone), 4)) -%>
    })
<% end -%>
<% if object.msg_prefix -%>
<%   if alone.empty? -%>
    return {'<%= object.msg_prefix %>': request}
<%   else -%>
    v = {'<%= object.msg_prefix %>': request}
    v.update(alone_param)
    return v
<%   end -%>
<% else -%>
<%   if alone.empty? -%>
    return request
<%   else -%>
    return request.update(alone_param)
<%   end -%>
<% end -%>


def resource_to_update(module):
<%
  properties_in_request = [
    object&.parameters&.reject(&:alone_parameter)&.select { |p| p.create_update == 'u' || p.create_update == 'cu' },
    object.properties.reject(&:output).reject(&:update_url).select { |p| p.create_update == 'u' || p.create_update == 'cu' },
  ].flatten.compact
-%>
    request = remove_nones_from_dict({
<% if object.kind? -%>
        u'kind': <%= quote_string(object.kind) -%>,
<% end # if object.kind? -%>
<%= lines(indent(request_properties(properties_in_request), 4)) -%>
    })
<%
  alone = object.alone_parameters.select { |p| p.create_update == 'u' || p.create_update == 'cu' }
-%>
<% if not alone.empty? -%>
    alone_param = remove_nones_from_dict({
 <%= lines(indent(request_properties(alone), 4)) -%>
    })
<% end -%>
<% if object.msg_prefix -%>
<%   if alone.empty? -%>
    return {'<%= object.msg_prefix %>': request}
<%   else -%>
    v = {'<%= object.msg_prefix %>': request}
    v.update(alone_param)
    return v
<%   end -%>
<% else -%>
<%   if alone.empty? -%>
    return request
<%   else -%>
    return request.update(alone_param)
<%   end -%>
<% end -%>


<% unless no_ex_properties || resource_editable_ps.empty? -%>
def _get_resource_editable_properties(module):
    request = remove_nones_from_dict({
<% resource_editable_ps.map do |p| -%>
<%= indent("\"#{p.out_name}\": module.params.get(\"#{p.out_name}\"),", 8)-%>
<%= "\n" -%>
<% end -%>
    })

    return request


<% end -%>
def _get_editable_properties(module):
<%
  ps = object.properties.reject(&:output).select { |p| p.create_update == 'u' || p.create_update == 'cu' }
-%>
    request = remove_nones_from_dict({
<% ps.map do |p| -%>
<%= indent("\"#{p.out_name}\": module.params.get(\"#{p.out_name}\"),", 8)-%>
<%= "\n" -%>
<% end -%>
    })

    return request


# Remove unnecessary properties from the response.
# This is for doing comparisons with Ansible's current parameters.
def response_to_hash(module, response):
    return {
<%= lines(response_properties(object.properties)) -%>
    }
<%= lines_before(selflink_functions(object), 1) -%>
<%= lines_before(compile('templates/ansible/async.erb'), 1) -%>
<%= lines_before(compile('templates/ansible/provider_helpers.erb'), 1) -%>
<%= lines_before(compile('templates/ansible/properties.erb'), 1) -%>


if __name__ == '__main__':
    main()
