#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2018 Huawei
# GNU General Public License v3.0+ (see COPYING or
# https://www.gnu.org/licenses/gpl-3.0.txt)
<%= lines(autogen_notice :python) -%>

from __future__ import absolute_import, division, print_function
__metaclass__ = type

###############################################################################
# Documentation
###############################################################################

<%
  metadata_version = quote_string(@config.manifest.get('metadata_version',
                                                       config))
  supported_by = quote_string(@config.manifest.get('supported_by', config))
-%>
ANSIBLE_METADATA = {'metadata_version': <%= metadata_version -%>,
                    'status': <%= @config.manifest.get('status', config) -%>,
                    'supported_by': <%= supported_by -%>}

DOCUMENTATION = '''
---
module: <%= module_name(object) %>
description:
<%= lines(indent(bullet_lines(object.description, 4), 4)) -%>
short_description: Creates a resource of <%= product_name.capitalize %>/<%= object.name %> in <%= cloud_name %>
version_added: <%= lines(@config.manifest.get('version_added', config)) -%>
author: <%= lines(@config.manifest.get('author', config)) -%>
requirements:
<% @config.manifest.get('requirements', config).each do |line| -%>
<%= lines(indent(bullet_line(line, 4, false, false), 4)) -%>
<% end -%>
options:
    state:
        description:
            - Whether the given object should exist in <%= cloud_name %>.
        choices: ['present', 'absent']
        default: 'present'
<% object.not_output_properties.each do |prop| -%>
<%= lines(indent(doc_property_yaml(prop, object, 4), 4)) -%>
<% end -%>
extends_documentation_fragment: hwc
'''

<%if example -%>
EXAMPLES = '''
<%#<% res_readable_name = Google::StringUtils.uncombine(object.name) -%>
<% if example.dependencies -%>
<%   example.dependencies.each do |depend| -%>
<%= lines(depend.build_test('present', object, false)) -%>
<%   end # example.dependencies.each -%>
<% end # if example.dependencies -%>
<%= lines(example.task.build_example('present', object)) -%>
'''

<% end -%>
RETURN = '''
<% object.all_user_properties.each do |prop| -%>
<%= lines(indent(return_property_yaml(prop, 4), 4)) -%>
<% end -%>
'''

###############################################################################
# Imports
###############################################################################

from ansible.module_utils.hwc_utils import (HwcSession, HwcModule,
                                            DictComparison, navigate_hash,
                                            remove_nones_from_dict,
                                            remove_empty_from_dict,
                                            HwcClientException,
                                            HwcClientException404)
<%
  imports = ['json']
  imports << 're'
-%>
<%= lines(imports.sort.uniq.map { |i| "import #{i}" }) -%>

###############################################################################
# Main
###############################################################################


<%
  # prod_name = object.__product.prefix[1..-1]
-%>
def main():
    """Main function"""

<%
  mod_props = object.not_output_properties.map do |prop|
    python_dict_for_property(prop, object)
  end
-%>
    module = HwcModule(
        argument_spec=dict(
            state=dict(default='present', choices=['present', 'absent'],
                       type='str'),
<%= lines(indent_list(mod_props, 12)) -%>
        )
    )

<% list_api = object.apis.fetch("list", nil)
   raise "no list api" if list_api.nil?
-%>
    resource = fetch_resource(config)
<% if object.apis["read"].path.match('/{id}') -%>
    module.params['id'] = navigate_value(resource, [<%= index2navigate(list_api.resource_id_path) %>])
<% end -%>

    result = {}
    changed = False
    if module.params['state'] == 'present':
        if resource is None:
            result = create(config)
            changed = True

        else:
<% unless updatable?(object) -%>
            result = read_resource(config)
<% else -%>
            current = read_resource(config, include_computed=False)
            expect = _expect_state(module)
            if not is_different(expect, current):
                result = update(config)
                changed = True
            else:
                result = read_resource(config)
<% end # updateable(object)? -%>
    else:
        if resource:
            delete(config)
            changed = True

    result['changed'] = changed
    module.exit_json(**result)


def user_input_parameters(module):
    return {
<% object.not_output_properties.each do |prop| -%>
        "<%= prop.out_name %>": module.params.get("<%= prop.out_name %>"),
<% end -%>
    }


<% create_api = object.apis["create"] -%>
def create(config):
    module = config.module
    opts = user_input_parameters(module)
    params = dict()
<%= lines(build_expand_properties(object, create_api.parameters, "create", "opts, None", create_api.out_name, "params", false), 1) -%>
    client = config.client(<%= argu_for_sdkclient(create_api) %>)
    link = build_path(module, "<%= create_api.path %>")

    r = None
<%=
  indent(send_request(
     "r = " + method_call("client.#{create_api.verb.downcase}", ['link', 'params'])
  ), 4)
%>

<%   if create_api.async.nil? -%>
    module.params['id'] = navigate_value(r, [<%= index2navigate(create_api.resource_id_path ) %>])
<%   else -%>
    timeout = 60 * int(module.params['timeouts']['create'].rstrip('m'))
    obj = async_wait(config, r, client, timeout)
    module.params['id'] = navigate_value(obj, [<%= index2navigate(create_api.async.result.field) %>])
<%   end # object.async-%>

    return read_resource(config)
<% if updatable?(object) -%>


def update(config):
    module = config.module
    opts = user_input_parameters(module)
<%   update_api = object.apis.fetch("update", nil) -%>
<%   unless update_api.nil? -%>

    params = dict()
<%= lines(build_expand_properties(object, update_api.parameters, "upate", "opts, None", update_api.out_name, "params", false), 1) %>

    client = config.client(<%= argu_for_sdkclient(update_api) %>)
    link = build_path(module, "<%= update_api.path %>")

<%     if update_api.async.nil? -%>
<%=
  indent(send_request(
    method_call("client.#{update_api.verb.downcase}", ['link', 'params'])
  ), 4)
%>
<%     else -%>
<%=
  indent(send_request(
    "r = " + method_call("client.#{update_api.verb.downcase}", ['link', 'params'])
  ), 4)
%>

    timeout = 60 * int(module.params['timeouts']['update'].rstrip('m'))
    async_wait(config, r, client, timeout)
<%     end -%>

<%   end # update_api.nil? -%>
    return get_resource(config)
<% end # updatable? -%>


<% delete_api = object.apis["delete"] -%>
def delete(config):
    module = config.module
    client = config.client(<%= argu_for_sdkclient(delete_api) %>)
    link = build_path(module, "<%= delete_api.path %>")

<% if delete_api.async.nil? -%>
<%   if create_api.async.nil? -%>
<%=
  indent(send_request(
    method_call("client.delete", ['link']), "", "config.module"
  ), 4)
%>
<%   else # if create api is async, then it is best to make sure the resource is delete successfully -%>
<%   end -%>
<% else -%>
<%=
  indent(send_request(
    "r = " + method_call("client.delete", ['link']), "", "config.module"
  ), 4)
%>
    timeout = 60 * int(module.params['timeouts']['delete'].rstrip('m'))
    async_wait(config, r, client, timeout)
<% end -%>


<%- read_api = object.apis["read"] %>
def read_resource(config, include_computed=True):
    module = config.module
    link = build_path(module, "<%= read_api.path %>")
    client = config.client(<%= argu_for_sdkclient(read_api) %>)

    v = None
<%=
  indent(send_request(
    "v = client.get(link)", "", "session.module"
  ), 4)
%>

    res = {"<%= read_api.out_name%>": v}

    r = user_input_parameters(module)

<% properties_to_show(object).each do |prop| -%>
<%  if prop.crud.eql?("r") -%>
    if include_computed:
<%= convert_resp_parameter(prop, "res, None", "", "r", 8) %>
<%  else -%>
<%= convert_resp_parameter(prop, "res, None", "", "r", 4) %>
<%  end -%>

<% end -%>
    return r


<% properties_to_show(object).each do |prop| -%>
<%= lines(build_flatten_method("", prop), 1) -%>
<% end -%>


<% list_api = object.apis.fetch("list", nil) -%>
def get_resource_id(config):
    r = read_resource_by_list(config)
    if r:
        return r["<%= list_api.resource_id_path %>"]


def read_resource_by_list(config):
    module = config.module
    opts = user_input_parameters(module)
    identity = {
<% list_api.identity.each do |k, v| -%>
<%   p = find_property(object, v.split("."))
     unless p.required
       raise "property(#{p.name}) referenced by list identity#{k} must be required"
     end
-%>
        "<%= k %>": navigate_value(opts, [<%= index2navigate(v, true) %>], None)
<% end -%>
    }

    link = build_path(module, "<%= list_api.path %>")
<% query_link = build_list_query_params(list_api, 4) -%>
<% unless query_link.empty? -%>

<%=  lines(query_link, 1) %>

    if link[-1] != "?":
        link += "?"
    link += query_link
<% end -%>

<% if list_api.query_params.include?('marker') -%>
    p = {'marker': ''}
    while True:
        rlink = link % p
        # read
        for item in r:
            for k, v in identity.items():
                if item[k] != v:
                    break
            else:
                return item

        p['marker'] = r[-1].get(<%= quote_string(list_api.resource_id_path) -%>)
<% elsif list_api.query_params.include?('offset') -%>
    p = {'offset': 0}
    while True:
        rlink = link % p
        # read
        for item in r:
            for k, v in identity.items():
                if item[k] != v:
                    break
            else:
                return item

        p['offset'] += 1
<% else -%>
    # read
    for item in v:
        for k, v in identity.items():
        if item[k] != v:
            break
    else:
        return item
<% end -%>
