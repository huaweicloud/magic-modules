<% if object.async -%>
<%
  stat_path = path2navigate(object.async.status.path)
  res_path = path2navigate(object.async.result.path)
  op_path = path2navigate(object.async.operation.path)
  async_url = async_operation_url(object, object.async.operation.base_url)
  res_url = async_operation_url(object, object.async.result.base_url)
-%>
def resource_get_url(module, wait_done):
    op_id = navigate_hash(wait_done, <%= res_path -%>)
    endpoint = get_service_endpoint(module, <%=quote_string(object.service_type)%>)
    url = <%=quote_string(res_url)%>.format(**{'op_id': op_id})
    return endpoint + url


<%=
  lines(emit_link('async_op_url', async_url, object, true, object.async.operation.service_type || object.service_type), 2)
-%>
def wait_for_operation(module, op_type, op_result):
    op_id = navigate_hash(op_result, <%= op_path -%>)
    url = async_op_url(module, {'op_id': op_id})
    timeout = 60 * int(module.params['timeouts'][op_type].rstrip('m'))

<% if object.self_link_query.nil? -%>
    return wait_for_completion(url, timeout, module)
<% else # object.self_link_query.nil? -%>
    wait_for_completion(status, op_result, resource)
<%=
  lines(format(
    [
      [
        "return fetch_wrapped_resource(resource, #{obj_kind}",
        ("'#{object.self_link_query.kind}'," if object.self_link_query.kind?),
        "'#{object.self_link_query.items}')"
      ].join(' '),
      [
        [
         "return fetch_wrapped_resource(resource, #{obj_kind}",
         ("'#{object.self_link_query.kind}'," if object.self_link_query.kind?)
        ].join(' '),
        indent([
          "'#{object.self_link_query.items}')"
        ], 23) # 23 = align with ( previous line
      ],
      [
        "return fetch_wrapped_resource(resource, #{obj_kind}",
        indent([
          "'#{object.self_link_query.kind}',",
          "'#{object.self_link_query.items}')"
        ], 23) # 31 = align with ( previous line
      ]
    ], 4
  ))
-%>
<% end # object.self_link_query.nil? -%>


def wait_for_completion(op_uri, timeout, module):
<%
  err_path = path2navigate(object.async.error.path)
  # err_msg = object.async.error.message
  allowed_states = object.async.status.allowed.map { |x| quote_string(x) }
-%>
    start = time.time()
    time_passed = 0
    while time_passed <= timeout:
        try:
<% if object.kind? -%>
            op_result = fetch_resource(module, op_uri, '<%= op_kind -%>')
<% else # object.kind? -%>
            op_result = fetch_resource(module, op_uri)
<% end # object.kind? -%>
        except Exception:
            time.sleep(<%= sprintf('%.1f', object.async.operation.wait_ms / 1000.0) %>)
            time_passed = time.time() - start
            continue

        raise_if_errors(op_result, module)

        status = navigate_hash(op_result, <%= stat_path -%>)
        if status not in [<%= allowed_states.join(', ') -%>]:
            module.fail_json(msg="Invalid result %s" % status)
        if status == '<%= object.async.status.complete -%>':
            return op_result

        time.sleep(<%= sprintf('%.1f', object.async.operation.wait_ms / 1000.0) %>)
        time_passed = time.time() - start

    module.fail_json(msg="Timeout to wait completion")


def raise_if_errors(response, module):
<%
  err_path = path2navigate(object.async.error.path)
  err_msg = path2navigate(object.async.error.message)
-%>
    errors = navigate_hash(response, <%= err_path -%>)
    if errors:
        module.fail_json(msg=navigate_hash(response, <%= err_msg -%>))
<% end #if object.async -%>
